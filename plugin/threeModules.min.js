import*as e from"three";import{OrbitControls as t}from"https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";import{unzipSync as a,strFromU8 as n}from"https://unpkg.com/three@0.159.0/examples/jsm/libs/fflate.module.js";let LoaderUtils={createFilesMap:function(e){let t={};for(let a=0;a<e.length;a++){let n=e[a];t[n.name]=n}return t},getFilesFromItemList:function(e,t){let a=0,n=0,s=[],r={};function l(){++a===n&&t(s,r)}function i(e){if(e.isDirectory){let t=e.createReader();t.readEntries(function(e){for(let t=0;t<e.length;t++)i(e[t]);l()})}else e.isFile&&e.file(function(t){s.push(t),r[e.fullPath.slice(1)]=t,l()});n++}for(let o=0;o<e.length;o++){let d=e[o];"file"===d.kind&&i(d.webkitGetAsEntry())}}};export class ThreeModules{constructor(e){e&&(this.editor=e.editor?e.editor:null,this.sceneWrapper=e.sceneWrapper?e.sceneWrapper:null),this.scene=null,this.renderer=null,this.cls=null,this.postScenes=[],this.threeScenes={}}init(a,n){if(!this.editor&&!this.sceneWrapper){console.log("Error: insert option, editor or sceneWrapper!");return}let s=a,r=a.className,l=this;s.firstChild&&s.removeChild(s.firstChild);let i=new e.Scene;this.scene=i;let o=16/9,d=this.editor?this.editor.querySelector(".mogl3d-content"):null,c=d?d.getBoundingClientRect():null,p=c?.78*c.width:640,h=p/o;s.style.width=`${p}px`,s.style.height=`${h}px`;let m=new e.PerspectiveCamera(75,p/h,.1,1e3);m.position.set(1.2,.6,1.3);let u=new e.GridHelper(10);i.add(u),n&&i.add(n);let f=new e.PointLight(16777215,50);f.position.set(.8,1.4,1),i.add(f);let g=new e.AmbientLight;i.add(g);let b=new e.WebGLRenderer;this.renderer=b,b.setSize(p,h),s.appendChild(b.domElement);let L=new t(m,b.domElement);L.enableDamping=!0;let $=document.createElement("div");$.className="three-scene-btn-wrapper";let w=document.createElement("div");w.className="tooltip",s.appendChild(w);let y=document.createElement("button");y.tabIndex="-1",y.contentEditable=!1,y.innerText="Full",y.id="fullscreen-btn",y.className="three-scene-btn";let _=document.createElement("input");_.type="color",_.value="#222",_.innerText="BG",_.className="three-scene-btn",_.id="three-scene-btn-bg",_.addEventListener("input",()=>{i.background=new e.Color(_.value)});let x=document.createElement("button");x.className="three-scene-btn",x.contentEditable=!1,x.textContent="BG",x.style.backgroundColor="rgba(255, 255, 255, 0.8)",x.style.color="#333",x.addEventListener("click",()=>{_.click()}),_.style.visibility="hidden",_.style.position="absolute",_.style.zIndex="-1";let j=document.createElement("button");j.textContent="Grid",j.className="three-scene-btn",j.contentEditable=!1,j.id="three-scene-grid-btn",j.addEventListener("click",()=>{u.visible=!u.visible});let k=document.createElement("button");return k.textContent="Edit",k.className="three-scene-btn",k.contentEditable=!1,k.id="three-scene-edit-btn",k.addEventListener("click",()=>{console.log("edit mode: ",k),(""===w.style.display||"none"===w.style.display)&&(w.textContent="Getting ready..",w.style.display="block",setTimeout(()=>{w.style.display="none"},2e3))}),$.appendChild(y),$.appendChild(x),$.appendChild(_),$.appendChild(j),$.appendChild(k),s.appendChild($),window.addEventListener("resize",function(e){if(document.fullscreenElement)l.updateSize(b,m,screen.width,screen.height);else{if(!d)return;let t=d.getBoundingClientRect(),a=.78*t.width,n=a/o;s.style.width=`${a}px`,s.style.height=`${n}px`,l.updateSize(b,m,a,n)}}),y.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen&&(document.exitFullscreen(),s.appendChild($)):b.domElement.requestFullscreen().catch(e=>{alert(`Failed to Full Screen: ${e.message}`)})}),this.threeScenes[r]=i,!function e(){requestAnimationFrame(e),L.update(),b.render(i,m)}(),s}initPost(e,t){let a=Object.keys(this.threeScenes),n=document.querySelector(`#${t}`);this.loadFiles(e,null,e=>{let s=a.length;s>0?new Set(a).has(t)?this.addObject(e,this.threeScenes[t]):this.init(n,e):0===s&&this.init(n,e)})}getScene(){if(this.scene)return this.scene}addObject(e){scene?scene.add(e):this.scene.add(e)}updateScene(){}updateSize(e,t,a,n){t.aspect=a/n,t.updateProjectionMatrix(),e.setSize(a,n),e.setPixelRatio(window.devicePixelRatio)}loadItemList(e){LoaderUtils.getFilesFromItemList(e,function(e,t){this.loadFiles(e,t)})}loadFiles(t,a,n){if(t.length>0){a=a||LoaderUtils.createFilesMap(t);let s=new e.LoadingManager,r=[];s.setURLModifier(e=>(e=URL.createObjectURL(a[e]),r.push(e),e));let l=[".gltf",".fbx",".obj",".glb",".zip"];for(let i=0;i<t.length;i++)l.map(e=>{t[i].name.endsWith(e)&&this.loadFile(t[i],s,n)})}}loadFile(t,a,n){let s=t.name,r=s.split(".").pop().toLowerCase(),l=new FileReader;switch(l.addEventListener("progress",function(e){let t="("+Math.floor(e.total/1e3)+" KB)",a=Math.floor(e.loaded/e.total*100)+"%";console.log("Loading",s,t,a)}),r){case"fbx":l.addEventListener("load",async function(e){let t=e.target.result,{FBXLoader:r}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),l=new r(a),i=l.parse(t);i.name=s,n(i)},!1),l.readAsArrayBuffer(t);break;case"glb":l.addEventListener("load",async function(e){let t=e.target.result,a=await createGLTFLoader();a.parse(t,"",function(e){let t=e.scene;t.name=s,t.animations.push(...e.animations),n(t),a.dracoLoader.dispose()})},!1),l.readAsArrayBuffer(t);break;case"gltf":l.addEventListener("load",async function(e){let t=e.target.result,r=await createGLTFLoader(a);r.parse(t,"",function(e){let t=e.scene;t.name=s,t.animations.push(...e.animations),n(t),r.dracoLoader.dispose()})},!1),l.readAsArrayBuffer(t);break;case"obj":l.addEventListener("load",async function(e){let t=e.target.result,{OBJLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),r=new a().parse(t);r.name=s,n(r)},!1),l.readAsText(t);break;case"stl":l.addEventListener("load",async function(t){let a=t.target.result,{STLLoader:r}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/STLLoader.js"),l=new r().parse(a),i=new e.MeshStandardMaterial,o=new e.Mesh(l,i);o.name=s,n(o)},!1),void 0!==l.readAsBinaryString?l.readAsBinaryString(t):l.readAsArrayBuffer(t);break;case"svg":l.addEventListener("load",async function(t){let a=t.target.result,{SVGLoader:s}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/SVGLoader.js"),r=new s,l=r.parse(a).paths,i=new e.Group;i.scale.multiplyScalar(.1),i.scale.y*=-1;for(let o=0;o<l.length;o++){let d=l[o],c=new e.MeshBasicMaterial({color:d.color,depthWrite:!1}),p=s.createShapes(d);for(let h=0;h<p.length;h++){let m=p[h],u=new e.ShapeGeometry(m),f=new e.Mesh(u,c);i.add(f)}}n(i)},!1),l.readAsText(t);break;case"usdz":l.addEventListener("load",async function(e){let t=e.target.result,{USDZLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/USDZLoader.js"),n=new a().parse(t);n.name=s},!1),l.readAsArrayBuffer(t);break;default:console.error("Unsupported file format ("+r+").")}}}async function handleZIP(t,s){let r=a(new Uint8Array(t));if(r["model.obj"]&&r["materials.mtl"]){let{MTLLoader:l}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/MTLLoader.js"),{OBJLoader:i}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),o=new l().parse(n(r["materials.mtl"]));new i().setMaterials(o).parse(n(r["model.obj"]))}for(let d in r){let c=r[d],p=new e.LoadingManager;p.setURLModifier(function(e){let t=r[e];if(t){console.log("Loading",e);let a=new Blob([t.buffer],{type:"application/octet-stream"});return URL.createObjectURL(a)}return e});let h=d.split(".").pop().toLowerCase();switch(h){case"fbx":{let{FBXLoader:m}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),u=new m(p),f=u.parse(c.buffer);s(f);break}case"obj":{let{OBJLoader:g}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),b=new g().parse(c.buffer);b.name=filename,s(b);break}case"glb":{let L=await createGLTFLoader();L.parse(c.buffer,"",function(e){let t=e.scene;t.animations.push(...e.animations),s(t),L.dracoLoader.dispose()});break}case"gltf":{let $=await createGLTFLoader();$.parse(n(c),"",function(e){let t=e.scene;t.animations.push(...e.animations),s(t),$.dracoLoader.dispose()})}}}}async function createGLTFLoader(e){let{GLTFLoader:t}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js"),{DRACOLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/DRACOLoader.js"),n=new a;n.setDecoderPath("https://unpkg.com/three@0.159.0/examples/jsm/libs/draco/gltf/");let s=new t(e);return s.setDRACOLoader(n),s}