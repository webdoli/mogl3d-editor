import*as THREE from"three";import{OrbitControls}from"https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";import{unzipSync,strFromU8}from"https://unpkg.com/three@0.159.0/examples/jsm/libs/fflate.module.js";const LoaderUtils={createFilesMap:function(e){const t={};for(let n=0;n<e.length;n++){const s=e[n];t[s.name]=s}return t},getFilesFromItemList:function(e,t){let n=0,s=0;const a=[],r={};function o(){n++,n===s&&t(a,r)}function i(e){if(e.isDirectory){e.createReader().readEntries((function(e){for(let t=0;t<e.length;t++)i(e[t]);o()}))}else e.isFile&&e.file((function(t){a.push(t),r[e.fullPath.slice(1)]=t,o()}));s++}for(let t=0;t<e.length;t++){const n=e[t];"file"===n.kind&&i(n.webkitGetAsEntry())}}};export class ThreeModules{constructor(e){e&&(this.editor=e.editor?e.editor:null,this.sceneWrapper=e.sceneWrapper?e.sceneWrapper:null),this.scene=null,this.renderer=null,this.cls=null,this.postScenes=[],this.threeScenes={}}init(e,t){if(!this.editor&&!this.sceneWrapper)return void console.log("Error: insert option, editor or sceneWrapper!");let n=e,s=e.className;const a=this;n.firstChild&&n.removeChild(n.firstChild);const r=new THREE.Scene;this.scene=r;const o=16/9,i=this.editor?this.editor.querySelector(".mogl3d-content"):null,l=i?i.getBoundingClientRect():null;let c=l?.78*l.width:640,d=c/o;n.style.width=`${c}px`,n.style.height=`${d}px`;const p=new THREE.PerspectiveCamera(75,c/d,.1,1e3);p.position.set(1.2,.6,1.3);const m=new THREE.GridHelper(10);r.add(m),t&&r.add(t);const u=new THREE.PointLight(16777215,50);u.position.set(.8,1.4,1),r.add(u);const h=new THREE.AmbientLight;r.add(h);const f=new THREE.WebGLRenderer;this.renderer=f,f.setSize(c,d),n.appendChild(f.domElement);const L=new OrbitControls(p,f.domElement);L.enableDamping=!0;let g=document.createElement("div");g.className="three-scene-btn-wrapper";let b=document.createElement("div");b.className="tooltip",n.appendChild(b);let E=document.createElement("button");E.tabIndex="-1",E.contentEditable=!1,E.innerText="Full",E.id="fullscreen-btn",E.className="three-scene-btn";let w=document.createElement("input");w.type="color",w.value="#222",w.innerText="BG",w.className="three-scene-btn",w.id="three-scene-btn-bg",w.addEventListener("input",(()=>{r.background=new THREE.Color(w.value)}));let y=document.createElement("button");y.className="three-scene-btn",y.contentEditable=!1,y.textContent="BG",y.style.backgroundColor="rgba(255, 255, 255, 0.8)",y.style.color="#333",y.addEventListener("click",(()=>{w.click()})),w.style.visibility="hidden",w.style.position="absolute",w.style.zIndex="-1";let j=document.createElement("button");j.textContent="Grid",j.className="three-scene-btn",j.contentEditable=!1,j.id="three-scene-grid-btn",j.addEventListener("click",(()=>{m.visible=!m.visible}));let x=document.createElement("button");return x.textContent="Edit",x.className="three-scene-btn",x.contentEditable=!1,x.id="three-scene-edit-btn",x.addEventListener("click",(()=>{console.log("edit mode: ",x),""!==b.style.display&&"none"!==b.style.display||(b.textContent="Getting ready..",b.style.display="block",setTimeout((()=>{b.style.display="none"}),2e3))})),g.appendChild(E),g.appendChild(y),g.appendChild(w),g.appendChild(j),g.appendChild(x),n.appendChild(g),window.addEventListener("resize",(function(e){if(document.fullscreenElement)a.updateSize(f,p,screen.width,screen.height);else{if(!i)return;let e=.78*i.getBoundingClientRect().width,t=e/o;n.style.width=`${e}px`,n.style.height=`${t}px`,a.updateSize(f,p,e,t)}})),E.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen&&(document.exitFullscreen(),n.appendChild(g)):f.domElement.requestFullscreen().catch((e=>{alert(`Failed to Full Screen: ${e.message}`)}))})),this.threeScenes[s]=r,function e(){requestAnimationFrame(e),L.update(),f.render(r,p)}(),n}initPost(e,t){let n=Object.keys(this.threeScenes),s=document.querySelector(`.${t}`);this.loadFiles(e,null,(e=>{let a=n.length;if(a>0){new Set(n).has(t)?this.addObject(e,this.threeScenes[t]):this.init(s,e)}else 0===a&&this.init(s,e)}))}getScene(){if(this.scene)return this.scene}addObject(e){scene.add(e)}updateScene(){}updateSize(e,t,n,s){const a=n/s;t.aspect=a,t.updateProjectionMatrix(),e.setSize(n,s),e.setPixelRatio(window.devicePixelRatio)}loadItemList(e){LoaderUtils.getFilesFromItemList(e,(function(e,t){this.loadFiles(e,t)}))}loadFiles(e,t,n){if(e.length>0){t=t||LoaderUtils.createFilesMap(e);const s=new THREE.LoadingManager,a=[];s.setURLModifier((e=>(e=URL.createObjectURL(t[e]),a.push(e),e)));let r=[".gltf",".fbx",".obj",".glb",".zip"];for(let t=0;t<e.length;t++)r.map((a=>{e[t].name.endsWith(a)&&this.loadFile(e[t],s,n)}))}}loadFile(e,t,n){const s=e.name,a=s.split(".").pop().toLowerCase(),r=new FileReader;switch(r.addEventListener("progress",(function(e){const t="("+Math.floor(e.total/1e3)+" KB)",n=Math.floor(e.loaded/e.total*100)+"%";console.log("Loading",s,t,n)})),a){case"fbx":r.addEventListener("load",(async function(e){const a=e.target.result,{FBXLoader:r}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),o=new r(t).parse(a);o.name=s,n(o)}),!1),r.readAsArrayBuffer(e);break;case"glb":r.addEventListener("load",(async function(e){const t=e.target.result,a=await createGLTFLoader();a.parse(t,"",(function(e){const t=e.scene;t.name=s,t.animations.push(...e.animations),n(t),a.dracoLoader.dispose()}))}),!1),r.readAsArrayBuffer(e);break;case"gltf":r.addEventListener("load",(async function(e){const a=e.target.result,r=await createGLTFLoader(t);r.parse(a,"",(function(e){const t=e.scene;t.name=s,t.animations.push(...e.animations),n(t),r.dracoLoader.dispose()}))}),!1),r.readAsArrayBuffer(e);break;case"obj":r.addEventListener("load",(async function(e){const t=e.target.result,{OBJLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),r=(new a).parse(t);r.name=s,n(r)}),!1),r.readAsText(e);break;case"stl":r.addEventListener("load",(async function(e){const t=e.target.result,{STLLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/STLLoader.js"),r=(new a).parse(t),o=new THREE.MeshStandardMaterial,i=new THREE.Mesh(r,o);i.name=s,n(i)}),!1),void 0!==r.readAsBinaryString?r.readAsBinaryString(e):r.readAsArrayBuffer(e);break;case"svg":r.addEventListener("load",(async function(e){const t=e.target.result,{SVGLoader:s}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/SVGLoader.js"),a=(new s).parse(t).paths,r=new THREE.Group;r.scale.multiplyScalar(.1),r.scale.y*=-1;for(let e=0;e<a.length;e++){const t=a[e],n=new THREE.MeshBasicMaterial({color:t.color,depthWrite:!1}),o=s.createShapes(t);for(let e=0;e<o.length;e++){const t=o[e],s=new THREE.ShapeGeometry(t),a=new THREE.Mesh(s,n);r.add(a)}}n(r)}),!1),r.readAsText(e);break;case"usdz":r.addEventListener("load",(async function(e){const t=e.target.result,{USDZLoader:n}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/USDZLoader.js");(new n).parse(t).name=s}),!1),r.readAsArrayBuffer(e);break;default:console.error("Unsupported file format ("+a+").")}}}async function handleZIP(e,t){const n=unzipSync(new Uint8Array(e));if(n["model.obj"]&&n["materials.mtl"]){const{MTLLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/MTLLoader.js"),{OBJLoader:t}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),s=(new e).parse(strFromU8(n["materials.mtl"]));(new t).setMaterials(s).parse(strFromU8(n["model.obj"]))}for(const e in n){const s=n[e],a=new THREE.LoadingManager;a.setURLModifier((function(e){const t=n[e];if(t){console.log("Loading",e);const n=new Blob([t.buffer],{type:"application/octet-stream"});return URL.createObjectURL(n)}return e}));switch(e.split(".").pop().toLowerCase()){case"fbx":{const{FBXLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),n=new e(a).parse(s.buffer);t(n);break}case"obj":{const{OBJLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),n=(new e).parse(s.buffer);n.name=filename,t(n);break}case"glb":{const e=await createGLTFLoader();e.parse(s.buffer,"",(function(n){const s=n.scene;s.animations.push(...n.animations),t(s),e.dracoLoader.dispose()}));break}case"gltf":{const e=await createGLTFLoader();e.parse(strFromU8(s),"",(function(n){const s=n.scene;s.animations.push(...n.animations),t(s),e.dracoLoader.dispose()}));break}}}}async function createGLTFLoader(e){const{GLTFLoader:t}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js"),{DRACOLoader:n}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/DRACOLoader.js"),s=new n;s.setDecoderPath("https://unpkg.com/three@0.159.0/examples/jsm/libs/draco/gltf/");const a=new t(e);return a.setDRACOLoader(s),a}