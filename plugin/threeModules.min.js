import*as THREE from"three";import{OrbitControls}from"https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";import{unzipSync,strFromU8}from"https://unpkg.com/three@0.159.0/examples/jsm/libs/fflate.module.js";const LoaderUtils={createFilesMap:function(e){const t={};for(let n=0;n<e.length;n++){const a=e[n];t[a.name]=a}return t},getFilesFromItemList:function(e,t){let n=0,a=0;const s=[],r={};function o(){n++,n===a&&t(s,r)}function i(e){if(e.isDirectory){e.createReader().readEntries((function(e){for(let t=0;t<e.length;t++)i(e[t]);o()}))}else e.isFile&&e.file((function(t){s.push(t),r[e.fullPath.slice(1)]=t,o()}));a++}for(let t=0;t<e.length;t++){const n=e[t];"file"===n.kind&&i(n.webkitGetAsEntry())}}};export class ThreeModules{constructor(e){this.editor=e.editor}init(e,t){console.log("scn: ",e);let n=e;n.firstChild&&n.removeChild(n.firstChild);const a=new THREE.Scene;let s=.78*this.editor.querySelector(".mogl3d-content").getBoundingClientRect().width,r=s/aspectRatio;const o=new THREE.PerspectiveCamera(75,s/r,.1,1e3);o.position.set(1.2,.6,1.3);const i=new THREE.GridHelper(10);a.add(i),t&&a.add(t);const l=new THREE.PointLight(16777215,50);l.position.set(.8,1.4,1),a.add(l);const c=new THREE.AmbientLight;a.add(c);const d=new THREE.WebGLRenderer;d.setSize(s,r),n.appendChild(d.domElement);const p=new OrbitControls(o,d.domElement);p.enableDamping=!0;let m=document.createElement("div");m.className="three-scene-btn-wrapper";let u=document.createElement("div");u.className="tooltip",n.appendChild(u);let h=document.createElement("button");h.innerText="Full",h.id="fullscreen-btn",h.className="three-scene-btn";let f=document.createElement("input");f.type="color",f.value="#222",f.innerText="BG",f.className="three-scene-btn",f.id="three-scene-btn-bg",f.addEventListener("input",(()=>{a.background=new THREE.Color(f.value)}));let L=document.createElement("button");L.className="three-scene-btn",L.textContent="BG",L.style.backgroundColor="rgba(255, 255, 255, 0.8)",L.style.color="#333",L.addEventListener("click",(()=>{f.click()})),f.style.visibility="hidden",f.style.position="absolute",f.style.zIndex="-1";let g=document.createElement("button");g.textContent="Grid",g.className="three-scene-btn",g.id="three-scene-grid-btn",g.addEventListener("click",(()=>{i.visible=!i.visible}));let b=document.createElement("button");return b.textContent="Edit",b.className="three-scene-btn",b.id="three-scene-edit-btn",b.addEventListener("click",(()=>{if(console.log("tooltip.style.display: ",u.style.display),""===u.style.display||"none"===u.style.display){document.querySelector('[title="3D Scene Editor"]').click(),u.textContent="Getting ready..",u.style.display="block",setTimeout((()=>{u.style.display="none"}),2e3)}})),m.appendChild(h),m.appendChild(L),m.appendChild(f),m.appendChild(g),m.appendChild(b),n.appendChild(m),window.addEventListener("resize",(function(){let e=.78*this.editor.querySelector(".mogl3d-content").getBoundingClientRect().width,t=e/aspectRatio;o.aspect=e/t,o.updateProjectionMatrix(),d.setSize(e,t)})),h.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen&&(document.exitFullscreen(),n.appendChild(m)):d.domElement.requestFullscreen().catch((e=>{alert(`Failed to Full Screen: ${e.message}`)}))})),function e(){requestAnimationFrame(e),p.update(),d.render(a,o)}(),n}loadItemList(e){LoaderUtils.getFilesFromItemList(e,(function(e,t){this.loadFiles(e,t)}))}loadFiles(e,t,n){if(e.length>0){t=t||LoaderUtils.createFilesMap(e);const a=new THREE.LoadingManager,s=[];a.setURLModifier((e=>(e=URL.createObjectURL(t[e]),s.push(e),e)));let r=[".gltf",".fbx",".obj","glb","zip"];for(let t=0;t<e.length;t++)r.map((s=>{e[t].name.endsWith(s)&&this.loadFile(e[t],a,n)}))}}loadFile(e,t,n){const a=e.name,s=a.split(".").pop().toLowerCase(),r=new FileReader;switch(r.addEventListener("progress",(function(e){const t="("+Math.floor(e.total/1e3)+" KB)",n=Math.floor(e.loaded/e.total*100)+"%";console.log("Loading",a,t,n)})),s){case"fbx":r.addEventListener("load",(async function(e){const a=e.target.result,{FBXLoader:s}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),r=new s(t).parse(a);n(r)}),!1),r.readAsArrayBuffer(e);break;case"glb":r.addEventListener("load",(async function(e){const t=e.target.result,s=await createGLTFLoader();s.parse(t,"",(function(e){const t=e.scene;t.name=a,t.animations.push(...e.animations),n(t),s.dracoLoader.dispose()}))}),!1),r.readAsArrayBuffer(e);break;case"gltf":r.addEventListener("load",(async function(e){const s=e.target.result,r=await createGLTFLoader(t);r.parse(s,"",(function(e){const t=e.scene;t.name=a,t.animations.push(...e.animations),n(t),r.dracoLoader.dispose()}))}),!1),r.readAsArrayBuffer(e);break;case"obj":r.addEventListener("load",(async function(e){const t=e.target.result,{OBJLoader:s}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),r=(new s).parse(t);r.name=a,n(r)}),!1),r.readAsText(e);break;case"stl":r.addEventListener("load",(async function(e){const t=e.target.result,{STLLoader:s}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/STLLoader.js"),r=(new s).parse(t),o=new THREE.MeshStandardMaterial,i=new THREE.Mesh(r,o);i.name=a,n(i)}),!1),void 0!==r.readAsBinaryString?r.readAsBinaryString(e):r.readAsArrayBuffer(e);break;case"svg":r.addEventListener("load",(async function(e){const t=e.target.result,{SVGLoader:a}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/SVGLoader.js"),s=(new a).parse(t).paths,r=new THREE.Group;r.scale.multiplyScalar(.1),r.scale.y*=-1;for(let e=0;e<s.length;e++){const t=s[e],n=new THREE.MeshBasicMaterial({color:t.color,depthWrite:!1}),o=a.createShapes(t);for(let e=0;e<o.length;e++){const t=o[e],a=new THREE.ShapeGeometry(t),s=new THREE.Mesh(a,n);r.add(s)}}n(r)}),!1),r.readAsText(e);break;case"usdz":r.addEventListener("load",(async function(e){const t=e.target.result,{USDZLoader:n}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/USDZLoader.js");(new n).parse(t).name=a}),!1),r.readAsArrayBuffer(e);break;case"zip":r.addEventListener("load",(function(e){handleZIP(e.target.result,n)}),!1),r.readAsArrayBuffer(e);break;default:console.error("Unsupported file format ("+s+").")}}}async function handleZIP(e,t){const n=unzipSync(new Uint8Array(e));if(n["model.obj"]&&n["materials.mtl"]){const{MTLLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/MTLLoader.js"),{OBJLoader:t}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),a=(new e).parse(strFromU8(n["materials.mtl"]));(new t).setMaterials(a).parse(strFromU8(n["model.obj"]))}for(const e in n){const a=n[e],s=new THREE.LoadingManager;s.setURLModifier((function(e){const t=n[e];if(t){console.log("Loading",e);const n=new Blob([t.buffer],{type:"application/octet-stream"});return URL.createObjectURL(n)}return e}));switch(e.split(".").pop().toLowerCase()){case"fbx":{const{FBXLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/FBXLoader.js"),n=new e(s).parse(a.buffer);t(n);break}case"obj":{const{OBJLoader:e}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js"),n=(new e).parse(a.buffer);n.name=filename,t(n);break}case"glb":{const e=await createGLTFLoader();e.parse(a.buffer,"",(function(n){const a=n.scene;a.animations.push(...n.animations),t(a),e.dracoLoader.dispose()}));break}case"gltf":{const e=await createGLTFLoader();e.parse(strFromU8(a),"",(function(n){const a=n.scene;a.animations.push(...n.animations),t(a),e.dracoLoader.dispose()}));break}}}}async function createGLTFLoader(e){const{GLTFLoader:t}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js"),{DRACOLoader:n}=await import("https://unpkg.com/three@0.159.0/examples/jsm/loaders/DRACOLoader.js"),a=new n;a.setDecoderPath("https://unpkg.com/three@0.159.0/examples/jsm/libs/draco/gltf/");const s=new t(e);return s.setDRACOLoader(a),s}